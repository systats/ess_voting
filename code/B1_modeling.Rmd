---
title: "ESS Statistical Models"
subtitle: "Factor Scores"
author: "Rebecca & Simon "
output: html_notebook
---

## Packages

```{r}
pacman::p_load(dplyr, ggplot2, readr, haven, broom, purrr, tidyr, magrittr, labelled, sjPlot, viridis, forcats, ggthemes, cluster, factoextra, fpc)
```

## Data

```{r}
options(scipen = 999)
ess <- get(load("data/Rdata/ess_scores.Rdata"))
ches <- get(load("data/Rdata/ches_clust.Rdata"))

ess_prep <- ess %>%
  mutate(
    id = 1:n(),
    round_year = case_when(
      round == 8 ~ "2016",
      round == 7 ~ "2014",
      round == 6 ~ "2012",
      round == 5 ~ "2010",
      round == 4 ~ "2008",
      round == 3 ~ "2006",
      round == 2 ~ "2004",
      round == 1 ~ "2002",
      TRUE ~ "") %>% 
      as.numeric
    )

ches_prep <- ches %>%
  select(party_id, vote_id, cluster, lrgen)
```

```{r}
dat <- ess_prep %>% 
  left_join(ches_prep, by = c("vote_id", "party_id")) 

dat <- dat %>%
  mutate(vote_right = ifelse(cluster == "Right Populist", 1, 0)) %>%
  mutate(lr_dff = abs(lrscale - lrgen))
  
#save(data_final, file = "data/Rdata/data_final.Rdata")

dat %>%
  dplyr::select(lr_dff, lrgen, lrscale) %>%
  summary

table(dat$vote_right)
table(dat$cluster)


dat %>%
  filter(!is.na(vote_right)) %>%
  group_by(country, gndr, vote_right) %>%
  tally %>%
  filter(vote_right == 1) %>%
  ggplot(aes(gndr, n, fill = as.factor(gndr))) +
  geom_bar(stat = "identity") +
  facet_wrap(~country, scales = "free") +
  ggthemes::theme_hc() +
  ggthemes::scale_fill_hc()

dat %>% 
  mutate(vote_right = as.factor(vote_right*(gndr))) %>%
  ggplot(aes(vote_right, pc_trust, colour = vote_right)) +
  geom_boxplot()
  
```


# Modeling


```{r}
glimpse(dat)
library(lme4)
#devtools::install_github("strengejacke/sjPlot")
#devtools::install_github("lme4/lme4")
library(sjPlot)
#data_final$trust_scores
ml1 <- glmer(vote_right ~ pc_trust + pc_imm + pc_imm_econ + gndr + scale(edu) + scale(rel) + (1|country), data = dat, family = binomial(link = "logit"))
arm::display(ml1)
sjp.glmer(ml1)
# fixed params
plot_model(ml1, type = "est")
# plot_model(ml1, type = "std2")
ggran <- plot_model(ml1, type = "re", sort.est = T)

predict(ml1)


library(forecast)
ggran$data %>%
  mutate(term = fct_reorder(term, estimate)) %>%
  ggplot(aes(term, estimate)) +
  geom_point() + 
  coord_flip()

# random params
# marginal effects
sjp.glmer(ml1, type = "eff", vars = "rel")
sjp.glmer(ml1, type = "eff", vars = "gndr")
sjp.glmer(ml1, type = "eff", vars = "pc_trust")
sjp.glmer(ml1, type = "eff", vars = "pc_imm")
sjp.glmer(ml1, type = "eff", vars = "pc_imm_econ")
```

```{r}
sjp.glmer()
```




## brms

```{r}
library(brms)
fit <- brm(vote_right ~ trust_scores + (1|country), data = data_final, family = binomial("probit"))
summary(fit, waic = TRUE) 
plot(fit)
```






```{r}
summary(data_final)
glm2 <- glmer(vote_right ~ trust_scores + gndr + rel +(1|country), data = data_final, family = binomial(link = "logit"))
display(glm2)

library(sjPlot)
ggg <- sjp.glmer(glm2, type = "eff")
ggg
```

```{r}
ml1 <- lmer(lr_dff ~ trust_scores + gndr + (1|country), data = data_final)
display(ml1)
```


```{r}
library(sjPlot)
plot_model(ml1)
```




